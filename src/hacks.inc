// This file is part of Horizontal Shooter.
// Copyright (c) 2016 - 2017, Marcus Rowe <undisbeliever@gmail.com>.
// Distributed under The MIT License: https://opensource.org/licenses/MIT

namespace Hacks {

// Waits until the start of a new frame.
//
// If select is pressed then the CPU usage will be displayed to the user
// using INIDISP.
//
// INPUT: 16 bit A, 16 bit Index, DB = 0x7e, AUTOJOY, NMI
a16()
i16()
code()
function WaitFrameCpuUsage {
// state of the cpu usage debugger
// (byte)
allocate(_showCpuUsage, wram7e, 1)

    jsr     Dma.TransferOnNextVBlank

    sep     #$20
a8()

    // invert _showCpuUsage when select pressed

    lda.w   Controller.Joy1.pressed + 1
    bit.b   #JOYH.select
    beq     EndIf

        lda.w   _showCpuUsage
        beq     +
            lda.b   #0
            bra     ++
        +
            dec
        +
        sta.w   _showCpuUsage
EndIf:

    lda.w   _showCpuUsage
    beq     NoCpuUsage
        lda.b   #7
        sta.l   INIDISP

        jsr     WaitFrame

        lda.b   #15
        sta.l   INIDISP

        rep     #$30
    a16()
        rts

NoCpuUsage:
    rep     #$20
a16()
    jmp     WaitFrame
}

}

// vim: ft=bass-65816 ts=4 sw=4 et:

